<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Number Wheel Betting Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; overflow: hidden; }
        .wheel-container { position: relative; width: 350px; height: 350px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .wheel { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 10px solid #4a5568; background-image: conic-gradient(#2d3748 0deg 7.2deg, #1a202c 7.2deg 14.4deg, #2d3748 14.4deg 21.6deg, #1a202c 21.6deg 28.8deg, #2d3748 28.8deg 36deg, #1a202c 36deg 43.2deg, #2d3748 43.2deg 50.4deg, #1a202c 50.4deg 57.6deg, #2d3748 57.6deg 64.8deg, #1a202c 64.8deg 72deg, #2d3748 72deg 79.2deg, #1a202c 79.2deg 86.4deg, #2d3748 86.4deg 93.6deg, #1a202c 93.6deg 100.8deg, #2d3748 100.8deg 108deg, #1a202c 108deg 115.2deg, #2d3748 115.2deg 122.4deg, #1a202c 122.4deg 129.6deg, #2d3748 129.6deg 136.8deg, #1a202c 136.8deg 144deg, #2d3748 144deg 151.2deg, #1a202c 151.2deg 158.4deg, #2d3748 158.4deg 165.6deg, #1a202c 165.6deg 172.8deg, #2d3748 172.8deg 180deg, #1a202c 180deg 187.2deg, #2d3748 187.2deg 194.4deg, #1a202c 194.4deg 201.6deg, #2d3748 201.6deg 208.8deg, #1a202c 208.8deg 216deg, #2d3748 216deg 223.2deg, #1a202c 223.2deg 230.4deg, #2d3748 230.4deg 237.6deg, #1a202c 237.6deg 244.8deg, #2d3748 244.8deg 252deg, #1a202c 252deg 259.2deg, #2d3748 259.2deg 266.4deg, #1a202c 266.4deg 273.6deg, #2d3748 273.6deg 280.8deg, #1a202c 280.8deg 288deg, #2d3748 288deg 295.2deg, #1a202c 295.2deg 302.4deg, #2d3748 302.4deg 309.6deg, #1a202c 309.6deg 316.8deg, #2d3748 316.8deg 324deg, #1a202c 324deg 331.2deg, #2d3748 331.2deg 338.4deg, #1a202c 338.4deg 345.6deg, #2d3748 345.6deg 352.8deg, #1a202c 352.8deg 360deg); transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: 0 0 30px rgba(0,0,0,0.7), inset 0 0 25px rgba(0,0,0,0.5); }
        .wheel-number { position: absolute; width: 35px; height: 35px; top: 50%; left: 50%; margin-left: -17.5px; margin-top: -17.5px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; border-radius: 50%; font-size: 1rem; transition: transform 0.3s ease, background-color 0.3s ease; }
        .wheel-number.winner { background-color: #f59e0b !important; transform: translate(var(--tx), var(--ty)) scale(1.2) !important; box-shadow: 0 0 15px #f59e0b; color: #1a202c; }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-top: 40px solid #e11d48; z-index: 10; filter: drop-shadow(0 -2px 3px rgba(0,0,0,0.5)); }
        .number-grid-btn.selected { background-image: linear-gradient(to right, #2563eb, #3b82f6); color: white; border-color: #3b82f6; transform: scale(1.1); box-shadow: 0 0 15px rgba(59, 130, 246, 0.7); }
        .message-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .message-modal.visible { opacity: 1; pointer-events: auto; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200; }
        #chat-messages { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-screen">
    <canvas id="confetti-canvas"></canvas>

    <!-- Auth Container -->
    <div id="auth-container" class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
        <div>
            <h2 id="auth-title" class="text-center text-3xl font-extrabold text-white">Sign in</h2>
        </div>
        <form id="login-form" class="space-y-6">
            <input id="login-email" type="email" required class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700" placeholder="Email">
            <input id="login-password" type="password" required class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700" placeholder="Password">
            <button type="submit" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-md font-semibold">Sign in</button>
        </form>
        <form id="register-form" class="hidden space-y-6">
            <input id="register-email" type="email" required class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700" placeholder="Email">
            <input id="register-password" type="password" required class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700" placeholder="Password">
            <button type="submit" class="w-full py-2 px-4 bg-green-600 hover:bg-green-700 rounded-md font-semibold">Create Account</button>
        </form>
        <p class="text-center text-sm">
            <a href="#" id="toggle-auth" class="font-medium text-blue-400 hover:text-blue-300">Don't have an account? Sign up</a>
        </p>
    </div>

    <!-- Lobby Container -->
    <div id="lobby-container" class="hidden w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
        <h2 class="text-center text-3xl font-extrabold text-white">Game Lobby</h2>
        <div class="space-y-4">
            <button id="create-game-btn" class="w-full py-3 px-4 bg-green-600 hover:bg-green-700 rounded-md text-lg font-bold">Create New Game</button>
            <div class="border-t border-gray-600 pt-4">
                <input type="text" id="join-game-id" placeholder="Enter Game ID to Join" class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white">
                <button id="join-game-btn" class="w-full mt-2 py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-md text-lg font-bold">Join Game</button>
            </div>
        </div>
        <button id="lobby-logout-btn" class="w-full mt-4 py-2 bg-rose-600 hover:bg-rose-700 rounded-md font-semibold">Logout</button>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="hidden w-full h-full flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-7xl flex justify-between items-center mb-2 p-2 bg-black bg-opacity-20 rounded-lg">
            <div>Game ID: <span id="game-id-display" class="font-bold cursor-pointer" title="Click to copy"></span></div>
            <div id="game-status-display" class="text-xl font-bold text-yellow-400">Waiting for players...</div>
            <button id="game-logout-btn" class="px-4 py-2 bg-rose-600 hover:bg-rose-700 rounded-md font-semibold shadow-lg">Leave Game</button>
        </div>
        <div class="w-full max-w-7xl flex-grow flex flex-col lg:flex-row items-start justify-around bg-gray-800 rounded-lg shadow-2xl p-4 gap-4">
            <!-- Left Panel: Players & Chat -->
            <div class="w-full lg:w-1/4 h-full flex flex-col gap-4">
                <!-- Player List -->
                <div class="bg-gray-900 rounded-lg p-3 flex-shrink-0">
                    <h3 class="text-lg font-bold mb-2 text-center">Players</h3>
                    <div id="player-list" class="space-y-2"></div>
                </div>
                <!-- Chat -->
                <div class="bg-gray-900 rounded-lg p-3 flex flex-col flex-grow h-0">
                    <h3 class="text-lg font-bold mb-2 text-center">Live Chat</h3>
                    <div id="chat-messages" class="flex-grow overflow-y-auto pr-2 space-y-2 mb-2"></div>
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Say something..." class="flex-grow px-3 py-1 border border-gray-600 rounded-md bg-gray-700 text-white">
                        <button id="send-chat-btn" class="px-4 py-1 bg-blue-600 hover:bg-blue-700 rounded-md font-semibold">Send</button>
                    </div>
                    <div class="grid grid-cols-3 gap-1 mt-2">
                        <button class="chat-preset-btn text-xs p-1 rounded bg-gray-700 hover:bg-gray-600">Hi! üëã</button>
                        <button class="chat-preset-btn text-xs p-1 rounded bg-gray-700 hover:bg-gray-600">Good Luck! üçÄ</button>
                        <button class="chat-preset-btn text-xs p-1 rounded bg-gray-700 hover:bg-gray-600">I won! üéâ</button>
                    </div>
                </div>
            </div>

            <!-- Middle Panel: Game Wheel -->
            <div class="w-full lg:w-1/2 flex flex-col items-center justify-center">
                <h2 id="betting-timer" class="text-4xl font-bold mb-4 text-shadow"></h2>
                <div class="wheel-container">
                    <div class="pointer"></div>
                    <div id="wheel" class="wheel"></div>
                </div>
                <button id="start-game-btn" class="hidden mt-4 px-8 py-3 bg-green-600 hover:bg-green-700 rounded-md text-xl font-bold">Start Game</button>
            </div>

            <!-- Right Panel: Betting Controls -->
            <div id="betting-controls" class="w-full lg:w-1/4 flex-col hidden">
                 <h3 class="text-xl font-semibold mb-1 text-center">Select up to 5 Numbers</h3>
                 <p class="text-center text-gray-400 mb-2">Bet per number: <span id="bet-per-number" class="font-bold text-yellow-400">0</span></p>
                 <p class="text-center text-gray-400 mb-2">Total Bet: <span id="total-bet-display" class="font-bold text-yellow-400">0</span></p>
                 <div id="number-grid" class="grid grid-cols-5 gap-2 mb-4"></div>
                 <button id="place-bet-btn" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-md text-lg font-bold mt-auto disabled:bg-gray-600">Place Bet</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="message-modal" class="message-modal">
        <div id="message-box" class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
            <p id="message-text" class="text-xl mb-6"></p>
            <button id="message-close-btn" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-md font-semibold">Close</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp, updateDoc, runTransaction, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config and Init ---
        const firebaseConfig = { apiKey: "AIzaSyAJ9K9fQ0ThMB7aXB6qNHr3_yLUdqJgnCM", authDomain: "my-chain-reaction-game.firebaseapp.com", projectId: "my-chain-reaction-game", storageBucket: "my-chain-reaction-game.appspot.com", messagingSenderId: "32751418407", appId: "1:32751418407:web:ff8244007ef2b099d56202" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const lobbyContainer = document.getElementById('lobby-container');
        const gameContainer = document.getElementById('game-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const toggleAuth = document.getElementById('toggle-auth');
        const authTitle = document.getElementById('auth-title');
        const playerListEl = document.getElementById('player-list');
        const chatMessagesEl = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const wheel = document.getElementById('wheel');
        const gameStatusDisplay = document.getElementById('game-status-display');
        const bettingControls = document.getElementById('betting-controls');
        const placeBetBtn = document.getElementById('place-bet-btn');
        const numberGrid = document.getElementById('number-grid');
        const startGameBtn = document.getElementById('start-game-btn');
        const bettingTimerEl = document.getElementById('betting-timer');
        const gameIdDisplay = document.getElementById('game-id-display');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const messageCloseBtn = document.getElementById('message-close-btn');

        // --- Global State ---
        let currentUser = null;
        let currentGameId = null;
        let unsubscribeGame = null;
        let unsubscribeChat = null;
        let selectedNumbers = [];
        let isSpinning = false;
        
        // --- UTILITY ---
        function showMessage(text, type = 'info') {
            messageText.textContent = text;
            messageModal.classList.add('visible');
        }
        messageCloseBtn.addEventListener('click', () => messageModal.classList.remove('visible'));

        // --- Auth Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                lobbyContainer.style.display = 'block';
                gameContainer.style.display = 'none';
            } else {
                currentUser = null;
                authContainer.style.display = 'block';
                lobbyContainer.style.display = 'none';
                gameContainer.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, loginEmailInput.value, loginPasswordInput.value);
            } catch (error) {
                showMessage('Failed to sign in. Check credentials.', 'error');
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await createUserWithEmailAndPassword(auth, registerEmailInput.value, registerPasswordInput.value);
            } catch (error) {
                showMessage(error.code === 'auth/email-already-in-use' ? 'Email already in use.' : 'Registration failed.', 'error');
            }
        });
        
        toggleAuth.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.toggle('hidden');
            registerForm.classList.toggle('hidden');
            const isLogin = !loginForm.classList.contains('hidden');
            authTitle.textContent = isLogin ? 'Sign in' : 'Create Account';
            toggleAuth.textContent = isLogin ? "Don't have an account? Sign up" : "Already have an account? Sign in";
        });
        
        document.getElementById('lobby-logout-btn').addEventListener('click', () => signOut(auth));
        document.getElementById('game-logout-btn').addEventListener('click', leaveGame);


        // --- Lobby Logic ---
        document.getElementById('create-game-btn').addEventListener('click', async () => {
            const gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const gameRef = doc(db, 'games', gameId);
            await setDoc(gameRef, {
                host: currentUser.uid,
                status: 'waiting',
                betAmount: 100,
                players: {
                    [currentUser.uid]: { email: currentUser.email, balance: 1000, bets: [], ready: false }
                },
                createdAt: serverTimestamp()
            });
            joinGame(gameId);
        });

        document.getElementById('join-game-btn').addEventListener('click', async () => {
            const gameId = document.getElementById('join-game-id').value.toUpperCase();
            if (!gameId) return showMessage('Please enter a Game ID.', 'error');
            
            const gameRef = doc(db, 'games', gameId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists()) {
                 const gameData = gameSnap.data();
                 if(gameData.players[currentUser.uid]){
                     console.log("Player already in game. Rejoining.");
                 } else {
                    await updateDoc(gameRef, {
                        [`players.${currentUser.uid}`]: { email: currentUser.email, balance: 1000, bets: [], ready: false }
                    });
                 }
                joinGame(gameId);
            } else {
                showMessage('Game not found.', 'error');
            }
        });

        function joinGame(gameId) {
            currentGameId = gameId;
            lobbyContainer.style.display = 'none';
            gameContainer.style.display = 'flex';
            gameIdDisplay.textContent = gameId;
            
            unsubscribeGame = onSnapshot(doc(db, 'games', gameId), handleGameStateUpdate);
            const chatQuery = query(collection(db, 'games', gameId, 'chat'), orderBy('timestamp'));
            unsubscribeChat = onSnapshot(chatQuery, handleChatUpdate);
        }
        
        async function leaveGame() {
             if (unsubscribeGame) unsubscribeGame();
             if (unsubscribeChat) unsubscribeChat();
             
             if(currentGameId) {
                const gameRef = doc(db, 'games', currentGameId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const gameDoc = await transaction.get(gameRef);
                        if (!gameDoc.exists()) return;

                        const gameData = gameDoc.data();
                        delete gameData.players[currentUser.uid];

                        if (Object.keys(gameData.players).length === 0) {
                            transaction.delete(gameRef);
                        } else {
                            if (gameData.host === currentUser.uid) {
                                gameData.host = Object.keys(gameData.players)[0];
                            }
                            transaction.set(gameRef, gameData);
                        }
                    });
                } catch (e) {
                    console.error("Failed to leave game:", e);
                }
             }

             currentGameId = null;
             lobbyContainer.style.display = 'block';
             gameContainer.style.display = 'none';
        }

        // --- Game State Handler ---
        let bettingInterval;
        function handleGameStateUpdate(docSnap) {
            if (!docSnap.exists()) {
                showMessage('The game was closed by the host.', 'info');
                leaveGame();
                return;
            };
            const gameData = docSnap.data();
            
            updatePlayerList(gameData.players);
            gameStatusDisplay.textContent = gameData.status.toUpperCase();
            startGameBtn.style.display = (gameData.host === currentUser.uid && gameData.status === 'waiting' && Object.keys(gameData.players).length > 1) ? 'block' : 'none';

            const myPlayerData = gameData.players[currentUser.uid];
            if (!myPlayerData) {
                // This can happen if the host kicks a player, for example.
                showMessage("You have been removed from the game.", "info");
                leaveGame();
                return;
            }

            switch(gameData.status) {
                case 'betting':
                    bettingControls.style.display = 'flex';
                    placeBetBtn.disabled = myPlayerData.ready;
                    placeBetBtn.textContent = myPlayerData.ready ? "Waiting for others..." : "Place Bet";
                    document.getElementById('bet-per-number').textContent = gameData.betAmount;
                    document.getElementById('total-bet-display').textContent = selectedNumbers.length * gameData.betAmount;
                    startBettingTimer();
                    break;
                case 'spinning':
                    bettingControls.style.display = 'none';
                    clearInterval(bettingInterval);
                    bettingTimerEl.textContent = "Spinning!";
                    if (!isSpinning) spinTheWheel(gameData.winningNumber);
                    break;
                case 'results':
                    bettingControls.style.display = 'none';
                    isSpinning = false;
                    document.querySelectorAll('.wheel-number').forEach(n => n.classList.remove('winner'));
                    const winnerEl = document.querySelector(`.wheel-number[data-number='${gameData.winningNumber}']`);
                    if(winnerEl) winnerEl.classList.add('winner');
                    break;
                case 'gameOver':
                    bettingControls.style.display = 'none';
                    const winner = Object.values(gameData.players).find(p => p.balance > 0);
                    if(winner) showMessage(`${winner.email} wins the game!`, 'success');
                    break;
                default: // waiting
                    bettingControls.style.display = 'none';
                    bettingTimerEl.textContent = "";
            }
        }

        function updatePlayerList(players) {
            playerListEl.innerHTML = '';
            for (const uid in players) {
                const p = players[uid];
                const playerDiv = document.createElement('div');
                playerDiv.className = `p-2 rounded-md flex justify-between items-center ${p.balance <= 0 ? 'bg-red-900 opacity-50' : 'bg-gray-700'}`;
                playerDiv.innerHTML = `
                    <span>${p.email.split('@')[0]} ${uid === currentUser.uid ? '(You)' : ''}</span>
                    <span class="font-bold text-yellow-400">${p.balance}</span>
                `;
                playerListEl.appendChild(playerDiv);
            }
        }

        // --- Game Actions ---
        startGameBtn.addEventListener('click', async () => {
             const gameRef = doc(db, 'games', currentGameId);
             await updateDoc(gameRef, { status: 'betting' });
        });

        placeBetBtn.addEventListener('click', async () => {
            if (selectedNumbers.length === 0) return showMessage('Select at least one number.', 'error');
            
            const gameRef = doc(db, 'games', currentGameId);
            await updateDoc(gameRef, {
                [`players.${currentUser.uid}.bets`]: selectedNumbers,
                [`players.${currentUser.uid}.ready`]: true
            });
        });

        function startBettingTimer() {
            let seconds = 15;
            bettingTimerEl.textContent = `Betting ends in: ${seconds}s`;
            clearInterval(bettingInterval);
            bettingInterval = setInterval(async () => {
                seconds--;
                bettingTimerEl.textContent = `Betting ends in: ${seconds}s`;
                if (seconds <= 0) {
                    clearInterval(bettingInterval);
                    bettingTimerEl.textContent = "Bets are closed!";
                    const gameDoc = await getDoc(doc(db, 'games', currentGameId));
                    if (auth.currentUser.uid === gameDoc.data().host) {
                        triggerSpin();
                    }
                }
            }, 1000);
        }

        async function triggerSpin() {
            const gameRef = doc(db, 'games', currentGameId);
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    if (!gameDoc.exists() || gameDoc.data().status !== 'betting') return;
                    
                    const gameData = gameDoc.data();
                    const players = gameData.players;
                    const betAmount = gameData.betAmount;
                    const winningNumber = Math.floor(Math.random() * 50) + 1;

                    for (const uid in players) {
                        const p = players[uid];
                        if (p.balance <= 0) continue;
                        const totalBet = p.bets.length * betAmount;
                        let newBalance = p.balance - totalBet;
                        if (p.bets.includes(winningNumber)) newBalance += betAmount * 10;
                        players[uid].balance = newBalance < 0 ? 0 : newBalance;
                        players[uid].bets = [];
                        players[uid].ready = false;
                    }

                    transaction.update(gameRef, { status: 'spinning', winningNumber });

                    setTimeout(() => updateDoc(gameRef, { status: 'results' }), 5500);
                    setTimeout(() => {
                        const activePlayers = Object.values(players).filter(p => p.balance > 0).length;
                        const nextStatus = activePlayers > 1 ? 'betting' : 'gameOver';
                        updateDoc(gameRef, { players, status: nextStatus });
                    }, 9500);
                });
            } catch (e) { console.error("Spin transaction failed: ", e); }
        }

        function spinTheWheel(winningNumber) {
            isSpinning = true;
            const degreesPerNumber = 7.2;
            const randomOffset = (Math.random() - 0.5) * degreesPerNumber * 0.8;
            const targetAngle = (winningNumber - 1) * degreesPerNumber + randomOffset;
            const extraRevolutions = (Math.floor(Math.random() * 4) + 5) * 360;
            const finalRotation = extraRevolutions + (360 - targetAngle);
            wheel.style.transform = `rotate(${finalRotation}deg)`;
        }

        // --- Chat Logic ---
        function handleChatUpdate(snapshot) {
            chatMessagesEl.innerHTML = '';
            snapshot.forEach(doc => {
                const msg = doc.data();
                const msgDiv = document.createElement('div');
                const isYou = msg.senderId === currentUser.uid;
                msgDiv.className = `flex flex-col ${isYou ? 'items-end' : 'items-start'}`;
                msgDiv.innerHTML = `<span class="text-xs text-gray-400">${msg.senderEmail.split('@')[0]}</span><p class="px-3 py-1 rounded-lg ${isYou ? 'bg-blue-700' : 'bg-gray-600'}">${msg.message}</p>`;
                chatMessagesEl.appendChild(msgDiv);
            });
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        async function sendChatMessage(message) {
            if (!message.trim() || !currentGameId) return;
            await addDoc(collection(db, 'games', currentGameId, 'chat'), {
                senderId: currentUser.uid, senderEmail: currentUser.email, message, timestamp: serverTimestamp()
            });
        }
        sendChatBtn.addEventListener('click', () => { sendChatMessage(chatInput.value); chatInput.value = ''; });
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendChatMessage(chatInput.value); chatInput.value = ''; }});
        document.querySelectorAll('.chat-preset-btn').forEach(btn => btn.addEventListener('click', () => sendChatMessage(btn.textContent)));


        // --- Initial Setup ---
        function initializeGameUI() {
            const radius = 150;
            for (let i = 1; i <= 50; i++) {
                const angle = (i - 1) * 7.2;
                const numberEl = document.createElement('div');
                numberEl.className = 'wheel-number';
                numberEl.textContent = i;
                numberEl.dataset.number = i;
                const x = radius * Math.cos((angle - 90) * Math.PI / 180);
                const y = radius * Math.sin((angle - 90) * Math.PI / 180);
                numberEl.style.setProperty('--tx', `${x}px`);
                numberEl.style.setProperty('--ty', `${y}px`);
                numberEl.style.transform = `translate(${x}px, ${y}px)`;
                numberEl.style.backgroundColor = i % 2 === 0 ? '#4b5563' : '#1a202c';
                wheel.appendChild(numberEl);
            }
            for (let i = 1; i <= 50; i++) {
                 const btn = document.createElement('button');
                 btn.textContent = i;
                 btn.dataset.number = i;
                 btn.className = 'number-grid-btn p-1 border-2 border-gray-600 rounded-md text-sm';
                 btn.addEventListener('click', () => selectNumber(i, btn));
                 numberGrid.appendChild(btn);
            }
        }
        initializeGameUI();
        
        function selectNumber(num, btn) {
            const index = selectedNumbers.indexOf(num);
            if (index > -1) {
                selectedNumbers.splice(index, 1);
                btn.classList.remove('selected');
            } else {
                if (selectedNumbers.length < 5) {
                    selectedNumbers.push(num);
                    btn.classList.add('selected');
                } else {
                    showMessage(`Max 5 numbers allowed.`, 'error');
                }
            }
            document.getElementById('total-bet-display').textContent = selectedNumbers.length * 100; // Assuming betAmount is 100
        }
        
    </script>
</body>
</html>
